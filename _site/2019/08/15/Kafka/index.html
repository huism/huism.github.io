<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- <title>Kafka难学吗 - huism's  Blog</title> -->
	<title>Kafka难学吗 -  Person Blog</title>

	<link rel="shortcut icon" href="/styles/images/favicon1.png">
	<link rel="icon" href="/styles/images/favicon1.png">

	<link rel="stylesheet" href="/styles/css/index.css">
	<link rel="stylesheet" href="/styles/css/fontawesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="/styles/css/syntax.css">
	<link rel="canonical" href="/2019/08/15/Kafka/">
	<link rel="alternate" type="application/rss+xml" title="huism's  Blog" href="/feed.xml">
	
	<meta name="keywords" content="Kafka难学吗, huism's  Blog, 个人博客;学而不思则罔;思而不学则殆;生命不止;折腾不休">
	<meta name="description" content="个人博客;学而不思则罔;思而不学则殆;生命不止;折腾不休">

	<script src="/styles/js/jquery.min.js"></script>
	<!--[if lt IE 9]>
    	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  	<![endif]-->
  	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>

  <body class="index">

    <header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">
        <img src="/styles/images/logo1.png">
      </a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">    
        <li>
          <a href="/">Home</a>
        </li>
        <li>
          <a href="/categories/">归档</a>
        </li>
        <li>
          <a href="/tag">标签</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <!-- <li>
            <a><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></a>
        </li> -->
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">关于<b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a rel="nofollow" target="_blank" href="https://github.com/huism/">Github</a></li>
            <li><a rel="nofollow" target="_blank" href="https://github.com/huism">关于作者</a></li>
            <li><a rel="nofollow" href="/books">我的书单</a></li>
            <!-- <li><a rel="nofollow" href="http://www.hifreud.com/domains/">域名管理</a></li> -->
            <li><a rel="nofollow" href="/reference">推荐博客</a></li>
            <!-- <li><a href="/feed.xml">RSS订阅</a></li> -->
            <li class="divider"></li>
            <li><a rel="nofollow" target="_blank" href="https://github.com/huism/huism.github.io.git">本项目</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>
    <div class="docs-header" id="content">
  <div class="container">
  	
  		<!--
		    <h1>Kafka难学吗</h1>
		    <p>Post on Aug 15, 2019 by <a href="/about">huism</a></p>
		-->
		    <h1>It's our wits that make us men.</h1>
    
  </div>
</div>
    
      
<div class="banner">
  <div class="container">
  	
    	<a href="/categories/#笔记-ref">笔记</a>	/
    	<a href="/tag/#hadoop-ref">hadoop</a>
    
  </div>
</div>

    

    <div class="container docs-container">
  <div class="row">
    <div class="col-md-3">
      <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
  <h1>目录</h1>
  <ul class="nav sidenav">
  </ul>
  <!-- <div style="height: 200px;width: 200px;">
    <script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=&amp;m=0&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33" async="async"> 
    </script>
  </div> -->
</div>

 
      </div>
    </div>
    <div class="col-md-9" role="main">
      <div class="panel docs-content">
        <div class="wrapper">
            <header class="post-header">
              <h1 class="post-title">Kafka难学吗</h1>
              <!--
                <p class="post-meta">Aug 15, 2019</p>
              -->
              <div class="meta">Posted on <span class="postdate">Aug 15, 2019</span> By <a target="_blank" href="http://localhost:4000">huism</a></div>
              <br />
            </header>
            <article class="post-content">
              <ul id="markdown-toc">
  <li><a href="#kafka" id="markdown-toc-kafka">Kafka</a>    <ul>
      <li><a href="#初识kafka" id="markdown-toc-初识kafka">初识Kafka</a>        <ul>
          <li><a href="#基本概念" id="markdown-toc-基本概念">基本概念</a></li>
          <li><a href="#生产和消费初体验" id="markdown-toc-生产和消费初体验">生产和消费初体验</a></li>
        </ul>
      </li>
      <li><a href="#生产者" id="markdown-toc-生产者">生产者</a></li>
    </ul>
  </li>
</ul>

<h1 id="kafka">Kafka</h1>

<h2 id="初识kafka">初识Kafka</h2>
<p>apache kafka是由Apache开发的一种发布订阅消息系统，它是一个分布式、分区和重复的日志服务。Kafka之所以越来越受到青睐，得幸于它所扮演的三大角色：</p>

<ul>
  <li>消息系统：Kafka不仅提供和传统消息系统（消息中间件）同样的系统解耦、存储冗余、流量削峰、缓冲、异步、可扩展、可恢复性等功能，而且提供消息顺序性保障和回溯消费的功能。</li>
  <li>存储系统：Kafka将消息持久化到磁盘，相比内存，降低了消息丢失的风险。Kafka的消息持久化和多副本机制，让它可以作为长久的存储系统，只需设置消息保留策略即可。</li>
  <li>流式处理平台：Kafka可以为其他流式处理框架提供数据来源，并且提供完整的流式处理类库。</li>
</ul>

<h3 id="基本概念">基本概念</h3>
<p>一个典型的Kafka集群包括若干生产者（Producer）、若干节点（Broker）和若干消费者（Consumer），以及一个Zookeeper集群。如下图所示：</p>

<p><img src="/styles/images/kafka/kafka-cluster.jpg" alt="Kafka集群组成" /></p>

<p>其中Zookeeper是Kafka负责集群元数据管理，控制器的选举等操作。Producer是将消息发送到Borker，Borker负责将消息存储到磁盘，而Consumer负责从Broker订阅消息数据。</p>

<p>整个kafka体系结构引入是哪个术语：</p>

<ul>
  <li>Producer：发送消息的一方，负责创建消息，发送到Kafka中。</li>
  <li>Consumer：接收消息的一方，负责连接Kafka并接收消息，进而进行相应的业务逻辑。</li>
  <li>Broker：服务代理节点。对于 Kafka 而言， Broker 可以简单地看作一个独立的 Kafka 服务节点或 Kafka服务实例。大多数情况下也可以将Broker看作一台Kafka服务器，前提是这台服务器上只部署了一个Kafka实例。一个或多个Broker组成了 一个Kafka集群。</li>
  <li>Topic和Partition：Kafka中的消息以主题为单位进行归类，生产者将消息发送给特定的主题（发送到Kafka集群中的每条消息都需指定一个主题），而消费者负责订阅主题进行消费消息。</li>
</ul>

<p><strong>主题和分区</strong></p>

<p>topic是一个逻辑概念，它可以细分成很多partition，一个partition只能属于一个topic，有时候称分区为主题分区（Topic-Partition）。分区在存储层面上可以看成一个可追加得日志，消息被追加到某个分区时会分配一个特定的偏移量（offset）。offset是消息在分区上的唯一标识，Kafka用offset保障消息在分区上的顺序性，但是offset不是跨分区的，在分区间消息是无序的。</p>

<p>如下图所示，主题中有4个分区，消息被顺序追加到每个分区日志文件的尾部。
<img src="/styles/images/kafka/kafka-topic-partition.png" alt="kafka解析主题-分区" /></p>

<blockquote>
  <p><strong>注意</strong></p>

  <ul>
    <li>同一topic下的不同partition上的数据是不同的。</li>
    <li>一条消息只存储到某个topic中的一个partition上。</li>
    <li>主题中的消息是分区内有序，分区间无序。</li>
    <li>一个主题中的分区可以分布在不同的broker上，可以提供比单个broker更强大的性能。</li>
    <li>不同的consumer会记录自己的消费offset。</li>
  </ul>
</blockquote>

<p>如下图所示，生产者和消费者对分区内偏移量的维护。
<img src="/styles/images/kafka/kafka-consumer-partition.png" alt="分区内偏移量" /></p>

<blockquote>
  <p>每一条消息被发送到broker之前，会根据分区规则选择存储到哪个具体的分区。如果分区规则设定得合理，所有的消息都可以均匀地分配到不同的分区中。</p>

  <p>如果一个主题只对应一个文件，那么这个文件所在的机器 I/O 将会成为这个主题的性能瓶颈，而分区解决了这个问题。</p>

  <p>在创建主题的时候可以通过指定的参数来设置分区的个数，当然也可以在主题创建完成之后去修 改分区的数量，通过增加分区的数量可以实现水平扩展。</p>
</blockquote>

<p><strong>多副本（Replica）机制</strong></p>

<p>Kafka 为分区引入了多副本机制， 通过增加副本数量可以提升容灾能力。同一分区的不同副本中保存的是相同的消息(在同一时刻，副本之间并非完全一样)。</p>

<ul>
  <li>副本之间是 “一主多从”的关系，其中 leader副本负责处理读写请求， follower副本只负责与 leader副本的 消息同步。</li>
  <li>副本处于不同的 broker 中 ，当 leader 副本出现故障时，从 follower 副本中重新选举新的 leader副本对外提供服务。</li>
</ul>

<p>Kafka通过多副本机制实现了故障的自动转移，当 Kafka集群中某个 broker 失效时仍然能保证服务可用。</p>

<p><strong>多副本架构</strong></p>

<p>如下图所示，Kafka集群中有4个broker，某个主题中有3个分区，且副本因子(即副本个数〉也为 3，如此每个分区便有1个 leader副本和 2个 follower副本 。生产者和消费者只与leader副本进行交互，而follow副本只负责消息的同步，很多时候follower副本中的消息相对leader副本而言会有一定的滞后。</p>

<p><img src="/styles/images/kafka/kafka-muti-part.png" alt="多副本架构" /></p>

<blockquote>
  <p>分区中的所有副本统称为 AR ( Assigned Replicas)。所有与leader 副本保持一定程度同步的副本(包括leader副本在内）组成ISR (On-Sync Replicas)，ISR 集合是 AR 集合中的一个子集。</p>

  <ul>
    <li>消息会先发送leader副本，然后 follower副本才能从leader副本中拉取消息进行同步，同步期间内 follower 副本相对于 leader 副本而言会有一定程度的滞后。</li>
    <li>前面所说的“一定程度 的同步”是指可忍受的滞后范围，这个范围可以通过参数进行配置。</li>
    <li>与 leader 副本同步滞后过多的副本(不包括leader副本)组成OSR(Out-of-Sync Replicas)，由此可见，AR=ISR+OSR。</li>
    <li>在正常情况下，所有的follower副本都应该与leader副本保持一定程度的同步，即 AR=ISR, OSR 集合为空。</li>
    <li>leader 副本负责维护和跟踪ISR 集合中所有follower副 本的滞后状态，当follower 副本落后 太多或失效时，leader副本会把它从ISR集合中剔除。</li>
    <li>如果OSR集合中有follower副本“追上’了leader副本，那么 leader副本会把它从OSR集合转移至ISR集合。</li>
    <li>默认情况下，当leader副本发生故障时，只有在ISR集合中的副本才有资格被选举为新的leader，而在OSR集合中的副本则没有任何机会(不过这个原则也可以通过修改相应的参数配置来改变)。</li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Kafka 的复制机制既不是完全的同步复制，也不是单纯的异步复制。</strong></p>
</blockquote>

<h3 id="生产和消费初体验">生产和消费初体验</h3>
<p><strong>终端初体验</strong></p>

<p>创建一个名为<code class="highlighter-rouge">topic_name</code>的主题，并且该主题有4个分区，每个分区副本因子为3。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kafka-topic.sh --zookeeper node1:2181 --create --topic toptic_name --replication-factor 3 --partition 4</span>
</code></pre></div></div>
<p>展示主题<code class="highlighter-rouge">topic_name</code>的信息。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kafka-topic.sh --zookeeper node1:2181 --describe --topic topic_name</span>
</code></pre></div></div>
<p>创建消费者,并且消费主题<code class="highlighter-rouge">topic_name</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kafka-console-consumer.sh --bootstrap-server node1:9092 --topic topic_name</span>
</code></pre></div></div>
<p>创建生产者，并且生产消息到主题<code class="highlighter-rouge">topic_name</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kafka-console-producer.sh --broker-list node1:9092 --topic topic_name</span>

<span class="o">&gt;</span>hello world！    <span class="o">(</span>输入消息，在消费者终端可以看到此输出<span class="o">)</span>
<span class="o">&gt;</span>
</code></pre></div></div>

<p><strong>IDE初体验</strong></p>

<p>1.添加依赖</p>

<p>Kafka的Java相关maven依赖：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupid&gt;</span>org.apache.kafka<span class="nt">&lt;/groupid&gt;</span>
    <span class="nt">&lt;artifactid&gt;</span>kafka_clients<span class="nt">&lt;/artifactid&gt;</span>    
    <span class="nt">&lt;version&gt;</span>2.0.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2.生产者</p>

<p>生产者要往Kafka中写入消息。</p>

<ul>
  <li>首先要创建一个生产者客户端实例并设置一些配置参数。</li>
  <li>然后构建消息的ProducerRecord对象，其中必须包含所要发往的主题及消息的消息体，进而再通过生产者客户端实例将消息发出。</li>
  <li>最后可以通过close()方法来关闭生产者客户端实例并回收相应的资源。</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Producer</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="c1">//生产者客户端配置</span>
        <span class="nc">Properties</span> <span class="n">prop</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
        <span class="n">prop</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"bootstrap-server"</span><span class="o">,</span><span class="s">"node1:9092"</span><span class="o">);</span>
        <span class="o">....</span>
        
        <span class="c1">//创建生产者实例</span>
        <span class="nc">KafkaProducer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">producer</span> <span class="o">=</span> <span class="k">new</span> <span class="k">new</span> <span class="nc">KafkaProducer</span><span class="o">&lt;&gt;(</span><span class="n">prop</span><span class="o">);</span>
        
        <span class="c1">//构建消息实体</span>
        <span class="nc">ProducerRecord</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">record</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProducerRecord</span><span class="o">&lt;&gt;(</span><span class="n">topic_name</span><span class="o">,</span><span class="s">"message"</span><span class="o">);</span>
        
        <span class="c1">//发送消息</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">producer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">record</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        
        <span class="c1">//关闭资源</span>
        <span class="n">producer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3.消费者</p>

<p>消费者订阅主题消费消息：</p>

<ul>
  <li>首先创建一个消费者客户端实例并配置相应的参数。</li>
  <li>然后订阅主题并消费即可。</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(){</span>
        <span class="c1">//消费者客户端配置</span>
        <span class="nc">Properties</span> <span class="n">prop</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
        <span class="n">prop</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"bootstrap-server"</span><span class="o">,</span><span class="s">"node1:9092"</span><span class="o">);</span>
        <span class="n">prop</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"group.id"</span><span class="o">,</span><span class="s">"group_name"</span><span class="o">);</span>
        <span class="o">....</span>
        
        <span class="c1">//创建消费者实例</span>
        <span class="nc">KafkaConsumer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="k">new</span> <span class="nc">KafkaConsumer</span><span class="o">&lt;&gt;(</span><span class="n">prop</span><span class="o">);</span>
        
        <span class="c1">//订阅主题</span>
        <span class="n">consumer</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">Collection</span><span class="o">.</span><span class="na">singletoList</span><span class="o">(</span><span class="n">topic_name</span><span class="o">));</span>
        
        <span class="c1">//循环消费消息</span>
        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
            <span class="nc">ConsumerRecords</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofMillis</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
            <span class="k">for</span><span class="o">(</span><span class="nc">ConsumerRecord</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">record</span> <span class="o">:</span> <span class="n">records</span><span class="o">){</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="生产者">生产者</h2>

<p>待续</p>

            </article>
        </div>
      </div>
    </div>
  </div>
</div>

    
    <footer class="footer" role="contentinfo">
	<div class="container">
		<center>
		<p class="copyright">Copyright &copy; 2019-2019 <a href="https://github.com/huism"><code>huism</code></a>.</p>
		<p>Powered by <a href="http://jekyllrb.com">jekyll</a>, themed from <a href="http://lesscss.cn/">Less</a> . <!-- refactored by <a href="http://www.hifreud.com/">huism</a> --></p>
		</center>
	</div>
</footer>

<script src="/styles/js/jquery.min.js"></script>
<script src="/styles/js/bootstrap.min.js"></script>
<script src="/styles/js/holder.min.js"></script>
<script src="/styles/js/lessismore.js"></script>
<script src="/styles/js/application.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  </body>
</html>
